<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - गौраंगी ज्वैलर्स</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --maroon: #800020;
            --gold: #D4AF37;
        }
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .font-playfair { font-family: 'Playfair Display', serif; }
        .bg-maroon { background-color: var(--maroon); }
        .text-maroon { color: var(--maroon); }
        .btn {
            padding: 0.5rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            cursor: pointer;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-maroon { background-color: var(--maroon); color: white; }
        .btn-maroon:hover:not(:disabled) { background-color: #600018; }
        .btn-outline {
            background-color: transparent;
            color: #374151;
            border-color: #cbd5e1;
        }
        .btn-outline:hover:not(:disabled) { background-color: #e2e8f0; }
        .btn-delete {
            background-color: #fee2e2;
            color: #dc2626;
            border-color: #fecaca;
        }
        .btn-delete:hover { background-color: #fecaca; }
        .tab-btn-active {
            color: var(--maroon);
            border-color: var(--maroon);
        }
        .tab-btn-inactive {
            color: #6b7280;
            border-color: transparent;
        }
        .tab-btn-inactive:hover {
            color: #374151;
            border-color: #d1d5db;
        }
        /* Modal styles */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body>

    <!-- Login Section -->
    <div id="login-section" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg">
            <h1 class="font-playfair text-3xl text-maroon text-center mb-2">Admin Login</h1>
            <p class="text-center text-gray-500 mb-6">गौरांगी ज्वैलर्स Dashboard</p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="email" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-gold focus:border-gold">
                </div>
                <div class="mb-4">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-gold focus:border-gold">
                </div>
                <button type="submit" id="login-button" class="w-full btn btn-maroon">Login</button>
                <p id="login-error" class="text-red-500 text-sm text-center mt-4"></p>
            </form>
        </div>
    </div>

    <!-- Main Dashboard (hidden by default) -->
    <div id="dashboard-section" class="hidden">
        <header class="bg-white shadow-md sticky top-0 z-40">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="font-playfair text-2xl font-bold text-maroon">Admin Dashboard</h1>
                <button id="logout-button" class="btn btn-outline">Logout</button>
            </div>
        </header>

        <main class="container mx-auto p-6">
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="orders-tab" type="button" class="tab-btn-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        Orders
                    </button>
                    <button id="inventory-tab" type="button" class="tab-btn-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        Inventory
                    </button>
                    <button id="catalog-tab" type="button" class="tab-btn-inactive whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        Catalog & Categories
                    </button>
                </nav>
            </div>

            <section id="orders-content">
                <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                    <h2 class="font-playfair text-3xl font-bold text-gray-800">Customer Orders</h2>
                    <div class="flex items-center gap-2">
                        <button id="add-order-btn" class="btn btn-maroon">Add New Order</button>
                    </div>
                </div>
                <div id="filters-container" class="mb-6">
                    <form id="search-form" class="flex items-center gap-2 bg-white p-4 rounded-lg shadow-sm">
                        <input type="text" id="search-input" placeholder="Search by name or bill number..." class="w-full md:w-64 px-4 py-2 border border-gray-300 rounded-md">
                        <button type="submit" class="btn btn-maroon">Search</button>
                        <button type="button" id="clear-search-btn" class="btn btn-outline">Clear</button>
                    </form>
                </div>
                <div class="bg-white rounded-lg shadow-md overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="p-4 font-semibold">Date</th>
                                <th class="p-4 font-semibold">Bill No.</th>
                                <th class="p-4 font-semibold">Customer Name</th>
                                <th class="p-4 font-semibold">Total Amount</th>
                                <th class="p-4 font-semibold">Paid Amount</th>
                                <th class="p-4 font-semibold">Pending Amount</th>
                                <th class="p-4 font-semibold">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body"></tbody>
                    </table>
                    <p id="no-orders-msg" class="text-center text-gray-500 py-8 hidden">No orders found.</p>
                </div>
                <div id="order-pagination-controls" class="flex justify-between items-center mt-4">
                    <button id="order-prev-page-btn" class="btn btn-outline">Previous</button>
                    <span id="order-page-info" class="text-sm text-gray-600"></span>
                    <button id="order-next-page-btn" class="btn btn-outline">Next</button>
                </div>
            </section>
            
            <section id="inventory-content" class="hidden">
                <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                    <h2 class="font-playfair text-3xl font-bold text-gray-800">Inventory</h2>
                    <div class="flex items-center gap-2">
                         <form id="inventory-search-form" class="flex-grow flex gap-2">
                            <input type="text" id="inventory-search-input" placeholder="Search by Item ID or Name..." class="w-full md:w-64 px-4 py-2 border border-gray-300 rounded-md">
                            <button type="submit" class="btn btn-maroon">Search</button>
                            <button type="button" id="inventory-clear-search-btn" class="btn btn-outline">Clear</button>
                        </form>
                        <button id="add-inventory-item-btn" class="btn btn-maroon">Add Item</button>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="p-4 font-semibold">Purchase Date</th>
                                <th class="p-4 font-semibold">Item ID</th>
                                <th class="p-4 font-semibold">Item Name</th>
                                <th class="p-4 font-semibold">Category</th>
                                <th class="p-4 font-semibold">Stock Qty</th>
                                <th class="p-4 font-semibold">Item Value</th>
                                <th class="p-4 font-semibold">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table-body"></tbody>
                    </table>
                    <p id="no-inventory-msg" class="text-center text-gray-500 py-8 hidden">No inventory items found.</p>
                </div>
                 <div id="inventory-pagination-controls" class="flex justify-between items-center mt-4">
                    <button id="inventory-prev-page-btn" class="btn btn-outline">Previous</button>
                    <span id="inventory-page-info" class="text-sm text-gray-600"></span>
                    <button id="inventory-next-page-btn" class="btn btn-outline">Next</button>
                </div>
            </section>

            <section id="catalog-content" class="hidden">
                 <h2 class="font-playfair text-3xl font-bold text-gray-800 mb-6">Catalog & Categories</h2>
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 flex flex-col gap-8">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-bold mb-4">Upload New Image</h3>
                            <form id="upload-form">
                                <div class="mb-4"><label for="image-title" class="block text-sm font-medium text-gray-700 mb-1">Image Title</label><input type="text" id="image-title" placeholder="e.g., Elegant Gold Necklace" required class="w-full px-4 py-2 border border-gray-300 rounded-md"></div>
                                <div class="mb-4"><label for="image-category" class="block text-sm font-medium text-gray-700 mb-1">Category</label><select id="image-category" required class="w-full px-4 py-2 border border-gray-300 rounded-md"><option>Loading categories...</option></select></div>
                                <div class="mb-4"><label for="image-file" class="block text-sm font-medium text-gray-700 mb-1">Image File</label><input type="file" id="image-file" accept="image/*" required class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-maroon/10 file:text-maroon hover:file:bg-maroon/20"></div>
                                <button type="submit" id="upload-btn" class="w-full btn btn-maroon">Upload Image</button>
                                <p id="upload-status" class="text-sm text-center mt-3"></p>
                            </form>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-bold mb-4">Manage Categories</h3>
                            <form id="category-form" class="flex gap-2 mb-4">
                                <input type="text" id="category-name" placeholder="New category name" required class="flex-grow px-4 py-2 border border-gray-300 rounded-md">
                                <button type="submit" class="btn btn-maroon flex-shrink-0">Add</button>
                            </form>
                            <div id="category-list" class="space-y-2"></div>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                         <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Existing Catalog Images</h3>
                            <button id="refresh-images-btn" class="btn btn-outline">Refresh</button>
                        </div>
                        <div id="catalog-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4 bg-white p-6 rounded-lg shadow-md min-h-[200px]"></div>
                         <p id="no-images-msg" class="text-center text-gray-500 py-8 hidden">No catalog images found.</p>
                    </div>
                 </div>
            </section>
        </main>
    </div>

    <!-- Add/Edit Order Modal -->
    <div id="order-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div id="modal-overlay" class="absolute inset-0 bg-black bg-opacity-50 modal-overlay"></div>
        <div id="modal-content" class="modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col transform scale-95">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 id="modal-title" class="font-playfair text-2xl text-maroon">Create New Order</h2>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <form id="new-order-form" class="flex-grow overflow-y-auto p-6 space-y-6">
                <input type="hidden" id="editing-order-id">
                <input type="hidden" id="editing-customer-id">
                <fieldset class="border p-4 rounded-md">
                    <legend class="text-lg font-semibold px-2">Customer & Bill Details</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label for="customer-name" class="block text-sm font-medium text-gray-700">Name*</label><input type="text" id="customer-name" required class="mt-1 w-full border-gray-300 rounded-md shadow-sm"></div>
                        <div><label for="physical-bill-number" class="block text-sm font-medium text-gray-700">Physical Bill Number</label><input type="text" id="physical-bill-number" class="mt-1 w-full border-gray-300 rounded-md shadow-sm"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div><label for="customer-mobile" class="block text-sm font-medium text-gray-700">Mobile</label><input type="tel" id="customer-mobile" class="mt-1 w-full border-gray-300 rounded-md shadow-sm"></div>
                        <div><label for="customer-address" class="block text-sm font-medium text-gray-700">Address</label><input type="text" id="customer-address" class="mt-1 w-full border-gray-300 rounded-md shadow-sm"></div>
                    </div>
                </fieldset>
                <fieldset class="border p-4 rounded-md">
                    <legend class="text-lg font-semibold px-2">Order Items</legend>
                    <div id="order-items-container" class="space-y-4"></div>
                    <button type="button" id="add-item-btn" class="mt-4 btn btn-outline text-sm">Add Another Item</button>
                </fieldset>
                <fieldset class="border p-4 rounded-md">
                    <legend class="text-lg font-semibold px-2">Payment & Remarks</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label for="remarks" class="block text-sm font-medium text-gray-700">Remarks</label><textarea id="remarks" rows="4" class="mt-1 w-full border-gray-300 rounded-md shadow-sm"></textarea></div>
                        <div class="space-y-2 text-right">
                            <div class="grid grid-cols-2 items-center"><p class="text-gray-500 text-left">Subtotal:</p><p id="subtotal-display" class="text-lg font-bold text-gray-900">₹0.00</p></div>
                            <div class="grid grid-cols-2 items-center"><p class="text-gray-500 text-left">Tax (3%):</p><p id="tax-display" class="text-lg font-bold text-gray-900">₹0.00</p></div>
                            <hr class="col-span-2">
                            <div class="grid grid-cols-2 items-center"><p class="font-bold text-left">Total Amount:</p><p id="total-amount-display" class="text-2xl font-bold text-gray-900">₹0.00</p></div>
                             <div class="grid grid-cols-2 items-center"><label for="discount-amount" class="text-lg font-medium text-gray-700 text-left">Discount:</label><input type="number" id="discount-amount" value="0" step="0.01" class="w-full border-gray-300 rounded-md shadow-sm text-right font-bold text-lg"></div>
                            <div class="grid grid-cols-2 items-center"><label for="paid-amount" class="text-lg font-medium text-gray-700 text-left">Paid Amount*:</label><input type="number" id="paid-amount" value="0" step="0.01" required class="w-full border-gray-300 rounded-md shadow-sm text-right font-bold text-lg"></div>
                            <hr class="col-span-2">
                            <div class="grid grid-cols-2"><p class="font-bold text-left">Pending Amount:</p><p id="pending-amount-display" class="text-2xl font-bold text-red-600">₹0.00</p></div>
                        </div>
                    </div>
                </fieldset>
            </form>
            <div class="p-4 bg-gray-50 border-t flex justify-end">
                <button type="submit" form="new-order-form" id="submit-order-btn" class="btn btn-maroon">Submit Order</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Inventory Modal -->
    <div id="inventory-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50 modal-overlay"></div>
        <div id="inventory-modal-content" class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col transform scale-95">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 id="inventory-modal-title" class="font-playfair text-2xl text-maroon">Add New Item</h2>
                <button id="close-inventory-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <form id="inventory-form" class="flex-grow overflow-y-auto p-6 space-y-4">
                <input type="hidden" id="editing-inventory-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label for="item-id" class="block text-sm font-medium">Item ID*</label><input type="text" id="item-id" required readonly class="mt-1 w-full border-gray-300 rounded-md shadow-sm bg-gray-100"></div>
                    <div><label for="item-name" class="block text-sm font-medium">Item Name*</label><input type="text" id="item-name" required class="mt-1 w-full border-gray-300 rounded-md shadow-sm"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label for="item-category" class="block text-sm font-medium">Category</label><select id="item-category" class="mt-1 w-full border-gray-300 rounded-md shadow-sm"></select></div>
                    <div><label for="item-material" class="block text-sm font-medium">Material</label><select id="item-material" class="mt-1 w-full border-gray-300 rounded-md shadow-sm"></select></div>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div><label for="item-weight" class="block text-sm font-medium">Total Weight (g)</label><input type="number" step="0.001" id="item-weight" class="mt-1 w-full border-gray-300 rounded-md shadow-sm"></div>
                    <div><label for="item-purity" class="block text-sm font-medium">Purity</label><input type="text" id="item-purity" placeholder="e.g., 22K or 92.5%" class="mt-1 w-full border-gray-300 rounded-md shadow-sm"></div>
                    <div><label for="item-stock" class="block text-sm font-medium">Stock Qty*</label><input type="number" id="item-stock" value="1" required class="mt-1 w-full border-gray-300 rounded-md shadow-sm"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label for="item-price" class="block text-sm font-medium">Price Per Gram</label><input type="number" step="0.01" id="item-price" class="mt-1 w-full border-gray-300 rounded-md shadow-sm"></div>
                    <div><label for="item-making-charges" class="block text-sm font-medium">Making Charges</label><input type="number" step="0.01" id="item-making-charges" value="0" class="mt-1 w-full border-gray-300 rounded-md shadow-sm"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label for="item-supplier" class="block text-sm font-medium">Supplier</label><select id="item-supplier" class="mt-1 w-full border-gray-300 rounded-md shadow-sm"></select></div>
                    <div><label for="purchase-date" class="block text-sm font-medium">Purchase Date</label><input type="date" id="purchase-date" class="mt-1 w-full border-gray-300 rounded-md shadow-sm"></div>
                </div>
            </form>
            <div class="p-4 bg-gray-50 border-t flex justify-end">
                <button type="submit" form="inventory-form" id="submit-inventory-btn" class="btn btn-maroon">Submit Item</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SUPABASE_URL = 'https://lyuaqxdzilptauihsfyf.supabase.co'; 
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5dWFxeGR6aWxwdGF1aWhzZnlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1ODQ2OTUsImV4cCI6MjA3MTE2MDY5NX0.Sf5skwobAoV26pHks6EeS2__aDVM3o5mT7Ensp6HIxQ';
            const BUCKET_NAME = 'catalog-images';
            const { createClient } = supabase;
            const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            const allElements = {
                loginSection: document.getElementById('login-section'),
                dashboardSection: document.getElementById('dashboard-section'),
                loginForm: document.getElementById('login-form'),
                loginButton: document.getElementById('login-button'),
                loginError: document.getElementById('login-error'),
                logoutButton: document.getElementById('logout-button'),
                ordersTableBody: document.getElementById('orders-table-body'),
                noOrdersMsg: document.getElementById('no-orders-msg'),
                searchForm: document.getElementById('search-form'),
                searchInput: document.getElementById('search-input'),
                clearSearchBtn: document.getElementById('clear-search-btn'),
                uploadForm: document.getElementById('upload-form'),
                uploadBtn: document.getElementById('upload-btn'),
                uploadStatus: document.getElementById('upload-status'),
                catalogGrid: document.getElementById('catalog-grid'),
                noImagesMsg: document.getElementById('no-images-msg'),
                refreshImagesBtn: document.getElementById('refresh-images-btn'),
                categoryForm: document.getElementById('category-form'),
                categoryList: document.getElementById('category-list'),
                imageCategorySelect: document.getElementById('image-category'),
                ordersTab: document.getElementById('orders-tab'),
                inventoryTab: document.getElementById('inventory-tab'),
                catalogTab: document.getElementById('catalog-tab'),
                ordersContent: document.getElementById('orders-content'),
                inventoryContent: document.getElementById('inventory-content'),
                catalogContent: document.getElementById('catalog-content'),
                addOrderBtn: document.getElementById('add-order-btn'),
                orderModal: document.getElementById('order-modal'),
                modalOverlay: document.getElementById('order-modal').querySelector('.modal-overlay'),
                modalContent: document.getElementById('order-modal').querySelector('.modal-content'),
                closeModalBtn: document.getElementById('close-modal-btn'),
                modalTitle: document.getElementById('modal-title'),
                newOrderForm: document.getElementById('new-order-form'),
                orderItemsContainer: document.getElementById('order-items-container'),
                addItemBtn: document.getElementById('add-item-btn'),
                paidAmountInput: document.getElementById('paid-amount'),
                discountInput: document.getElementById('discount-amount'),
                subtotalDisplay: document.getElementById('subtotal-display'),
                taxDisplay: document.getElementById('tax-display'),
                totalAmountDisplay: document.getElementById('total-amount-display'),
                pendingAmountDisplay: document.getElementById('pending-amount-display'),
                submitOrderBtn: document.getElementById('submit-order-btn'),
                orderPaginationControls: document.getElementById('order-pagination-controls'),
                orderPrevPageBtn: document.getElementById('order-prev-page-btn'),
                orderNextPageBtn: document.getElementById('order-next-page-btn'),
                orderPageInfo: document.getElementById('order-page-info'),
                inventoryTableBody: document.getElementById('inventory-table-body'),
                noInventoryMsg: document.getElementById('no-inventory-msg'),
                addInventoryItemBtn: document.getElementById('add-inventory-item-btn'),
                inventoryModal: document.getElementById('inventory-modal'),
                closeInventoryModalBtn: document.getElementById('close-inventory-modal-btn'),
                inventoryModalTitle: document.getElementById('inventory-modal-title'),
                inventoryForm: document.getElementById('inventory-form'),
                submitInventoryBtn: document.getElementById('submit-inventory-btn'),
                inventorySearchForm: document.getElementById('inventory-search-form'),
                inventorySearchInput: document.getElementById('inventory-search-input'),
                inventoryClearSearchBtn: document.getElementById('inventory-clear-search-btn'),
                inventoryPaginationControls: document.getElementById('inventory-pagination-controls'),
                inventoryPrevPageBtn: document.getElementById('inventory-prev-page-btn'),
                inventoryNextPageBtn: document.getElementById('inventory-next-page-btn'),
                inventoryPageInfo: document.getElementById('inventory-page-info'),
                inventoryItemCategory: document.getElementById('item-category'),
                inventoryItemMaterial: document.getElementById('item-material'),
                inventoryItemSupplier: document.getElementById('item-supplier'),
            };

            // --- STATE VARIABLES ---
            let currentOrderPage = 1;
            let totalOrderPages = 1;
            let currentInventoryPage = 1;
            let totalInventoryPages = 1;
            const PAGE_SIZE = 10;
            let currentEditingOrderId = null;
            let currentEditingCustomerId = null;
            let currentEditingInventoryId = null;
            let allCategories = [];
            let allInventoryItems = [];

            // --- TABS & MODALS ---
            allElements.ordersTab.addEventListener('click', () => switchTab('orders'));
            allElements.inventoryTab.addEventListener('click', () => switchTab('inventory'));
            allElements.catalogTab.addEventListener('click', () => switchTab('catalog'));
            function switchTab(activeTab) {
                const tabs = ['orders', 'inventory', 'catalog'];
                tabs.forEach(tab => {
                    const isActive = tab === activeTab;
                    allElements[`${tab}Tab`].className = `whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${isActive ? 'tab-btn-active' : 'tab-btn-inactive'}`;
                    allElements[`${tab}Content`].classList.toggle('hidden', !isActive);
                });
            }

            const openModal = (modal) => { modal.classList.remove('hidden'); setTimeout(() => { modal.querySelector('.modal-overlay').classList.remove('opacity-0'); modal.querySelector('.modal-content').classList.remove('scale-95'); }, 10); };
            const closeModal = (modal) => { modal.querySelector('.modal-overlay').classList.add('opacity-0'); modal.querySelector('.modal-content').classList.add('scale-95'); setTimeout(() => modal.classList.add('hidden'), 300); };

            allElements.addOrderBtn.addEventListener('click', () => { openModal(allElements.orderModal); resetOrderForm(); });
            allElements.closeModalBtn.addEventListener('click', () => closeModal(allElements.orderModal));
            allElements.orderModal.querySelector('.modal-overlay').addEventListener('click', () => closeModal(allElements.orderModal));
            
            allElements.addInventoryItemBtn.addEventListener('click', () => { openModal(allElements.inventoryModal); resetInventoryForm(); });
            allElements.closeInventoryModalBtn.addEventListener('click', () => closeModal(allElements.inventoryModal));
            allElements.inventoryModal.querySelector('.modal-overlay').addEventListener('click', () => closeModal(allElements.inventoryModal));

            // --- FILTERS ---
            allElements.clearSearchBtn.addEventListener('click', () => {
                allElements.searchInput.value = '';
                fetchOrders('', 1);
            });
            allElements.inventoryClearSearchBtn.addEventListener('click', () => {
                allElements.inventorySearchInput.value = '';
                fetchInventory('', 1);
            });

            // --- NEW/EDIT ORDER FORM LOGIC ---
            const calculateTotals = () => {
                let subtotal = 0;
                allElements.orderItemsContainer.querySelectorAll('.item-row').forEach(row => {
                    const weight = parseFloat(row.querySelector('.item-weight').value) || 0;
                    const rate = parseFloat(row.querySelector('.item-rate').value) || 0;
                    const makingCharge = parseFloat(row.querySelector('.item-making').value) || 0;
                    const itemSubtotal = (weight * rate) + makingCharge;
                    row.querySelector('.item-subtotal').textContent = `₹${itemSubtotal.toFixed(2)}`;
                    subtotal += itemSubtotal;
                });
                
                const taxAmount = subtotal * 0.03;
                const totalAmount = subtotal + taxAmount;
                const paidAmount = parseFloat(allElements.paidAmountInput.value) || 0;
                const discount = parseFloat(allElements.discountInput.value) || 0;
                const pendingAmount = totalAmount - paidAmount - discount;

                allElements.subtotalDisplay.textContent = `₹${subtotal.toFixed(2)}`;
                allElements.taxDisplay.textContent = `₹${taxAmount.toFixed(2)}`;
                allElements.totalAmountDisplay.textContent = `₹${totalAmount.toFixed(2)}`;
                allElements.pendingAmountDisplay.textContent = `₹${pendingAmount.toFixed(2)}`;
            };
            const addItemRow = (item = {}) => { 
                const itemHtml = `<div class="item-row grid grid-cols-12 gap-2 items-center border-t pt-4"><div class="col-span-12 md:col-span-3"><label class="text-sm">Item*</label><select class="item-inventory mt-1 w-full border-gray-300 rounded-md shadow-sm" required></select></div><div class="col-span-6 md:col-span-2"><label class="text-sm">Weight (g)*</label><input type="number" value="${item.weight_grams || ''}" step="0.001" class="item-weight mt-1 w-full border-gray-300 rounded-md shadow-sm" required></div><div class="col-span-6 md:col-span-2"><label class="text-sm">Rate/g*</label><input type="number" value="${item.rate_per_gram || ''}" step="0.01" class="item-rate mt-1 w-full border-gray-300 rounded-md shadow-sm" required></div><div class="col-span-6 md:col-span-2"><label class="text-sm">Making Charge*</label><input type="number" value="${item.making_charge || 0}" step="0.01" class="item-making mt-1 w-full border-gray-300 rounded-md shadow-sm" required></div><div class="col-span-6 md:col-span-2 text-right"><p class="text-sm text-gray-500">Subtotal</p><p class="item-subtotal font-bold text-lg">₹0.00</p></div><div class="col-span-12 md:col-span-1 flex justify-end"><button type="button" class="remove-item-btn text-red-500 hover:text-red-700 font-bold text-2xl mt-4">&times;</button></div></div>`; 
                allElements.orderItemsContainer.insertAdjacentHTML('beforeend', itemHtml); 
                const newInventorySelect = allElements.orderItemsContainer.lastElementChild.querySelector('.item-inventory');
                populateOrderItemInventoryDropdown(newInventorySelect, item.inventory_id);
            };
            const resetOrderForm = () => { 
                allElements.newOrderForm.reset(); 
                allElements.orderItemsContainer.innerHTML = ''; 
                addItemRow(); 
                calculateTotals(); 
                currentEditingOrderId = null;
                currentEditingCustomerId = null;
                allElements.modalTitle.textContent = 'Create New Order';
                allElements.submitOrderBtn.textContent = 'Submit Order';
            };
            allElements.addItemBtn.addEventListener('click', () => addItemRow());
            allElements.orderItemsContainer.addEventListener('click', (e) => { if (e.target.classList.contains('remove-item-btn')) { e.target.closest('.item-row').remove(); calculateTotals(); } });
            allElements.newOrderForm.addEventListener('input', calculateTotals);
            allElements.newOrderForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                allElements.submitOrderBtn.disabled = true;
                
                const isEditing = !!currentEditingOrderId;
                allElements.submitOrderBtn.textContent = isEditing ? 'Updating...' : 'Submitting...';

                // 1. Upsert Customer
                const customerData = { name: document.getElementById('customer-name').value, mobile: document.getElementById('customer-mobile').value, address: document.getElementById('customer-address').value };
                let customer;
                if (isEditing) {
                    const { data, error } = await supabaseClient.from('customers').update(customerData).eq('id', currentEditingCustomerId).select().single();
                    if (error) { alert('Failed to update customer details.'); allElements.submitOrderBtn.disabled = false; return; }
                    customer = data;
                } else {
                    const { data, error } = await supabaseClient.from('customers').insert(customerData).select().single();
                    if (error) { alert('Failed to save customer details.'); allElements.submitOrderBtn.disabled = false; return; }
                    customer = data;
                }
                
                // 2. Upsert Order
                const totalAmount = parseFloat(allElements.totalAmountDisplay.textContent.replace('₹', ''));
                const taxAmount = parseFloat(allElements.taxDisplay.textContent.replace('₹', ''));
                const paidAmount = parseFloat(allElements.paidAmountInput.value);
                const discount = parseFloat(allElements.discountInput.value);
                const remarks = document.getElementById('remarks').value;
                const physical_bill_number = document.getElementById('physical-bill-number').value;
                const orderData = { customer_id: customer.id, total_amount: totalAmount, tax_amount: taxAmount, paid_amount: paidAmount, discount: discount, remarks: remarks, physical_bill_number: physical_bill_number };
                
                let order;
                if (isEditing) {
                    const { data, error } = await supabaseClient.from('orders').update(orderData).eq('id', currentEditingOrderId).select().single();
                    if (error) { alert('Failed to update order.'); allElements.submitOrderBtn.disabled = false; return; }
                    order = data;
                } else {
                    const { data, error } = await supabaseClient.from('orders').insert(orderData).select().single();
                    if (error) { alert('Failed to save order. Bill number might already exist.'); allElements.submitOrderBtn.disabled = false; return; }
                    order = data;
                }

                // 3. Sync Order Items (Delete all existing, then insert new)
                if (isEditing) {
                    const { error: deleteError } = await supabaseClient.from('order_items').delete().eq('order_id', order.id);
                    if (deleteError) { alert('Failed to update order items.'); allElements.submitOrderBtn.disabled = false; return; }
                }
                const items = Array.from(allElements.orderItemsContainer.querySelectorAll('.item-row')).map(row => {
                    const inventoryId = row.querySelector('.item-inventory').value;
                    const selectedInventoryItem = allInventoryItems.find(invItem => invItem.id == inventoryId);
                    return {
                        order_id: order.id,
                        inventory_id: inventoryId,
                        weight_grams: parseFloat(row.querySelector('.item-weight').value),
                        rate_per_gram: parseFloat(row.querySelector('.item-rate').value),
                        making_charge: parseFloat(row.querySelector('.item-making').value),
                        metal_type: selectedInventoryItem ? selectedInventoryItem.material : 'N/A'
                    };
                });
                const { error: itemsError } = await supabaseClient.from('order_items').insert(items);

                if (itemsError) { alert('Failed to save order items.'); } 
                else { 
                    alert(`Order ${isEditing ? 'updated' : 'created'} successfully!`); 
                    if (!isEditing) {
                        for (const item of items) {
                            const { data: inventoryItem, error: inventoryError } = await supabaseClient.from('inventory').select('stock_qty').eq('id', item.inventory_id).single();
                            if (inventoryItem) {
                                const newStock = inventoryItem.stock_qty - 1;
                                await supabaseClient.from('inventory').update({ stock_qty: newStock }).eq('id', item.inventory_id);
                            }
                        }
                    }
                    closeModal(allElements.orderModal); 
                    fetchOrders(); 
                    fetchInventory();
                }
                
                allElements.submitOrderBtn.disabled = false;
            });

            // --- AUTH, FETCHING, DELETING ---
            const showDashboard = () => { allElements.loginSection.classList.add('hidden'); allElements.dashboardSection.classList.remove('hidden'); fetchOrders(); fetchInventory(); fetchAllInventoryItems(); fetchCatalogImages(); fetchCategories(); fetchMaterials(); fetchSuppliers(); };
            const showLogin = () => { allElements.loginSection.classList.remove('hidden'); allElements.dashboardSection.classList.add('hidden'); };

            const fetchOrders = async (searchTerm = '', page = 1) => {
                const from = (page - 1) * PAGE_SIZE;
                const to = page * PAGE_SIZE - 1;

                if (!searchTerm) {
                    const { data, error, count } = await supabaseClient
                        .from('orders')
                        .select(`id, created_at, total_amount, paid_amount, pending_amount, physical_bill_number, customers!inner(name, mobile)`, { count: 'exact' })
                        .order('created_at', { ascending: false })
                        .range(from, to);
                    
                    if (error) { console.error('Error fetching orders:', error); return; }
                    totalOrderPages = Math.ceil(count / PAGE_SIZE);
                    currentOrderPage = page;
                    displayOrders(data);
                    updatePaginationControls(count, 'order');
                } else {
                    const { data: billData, error: billError } = await supabaseClient
                        .from('orders')
                        .select(`id, created_at, total_amount, paid_amount, pending_amount, physical_bill_number, customers!inner(name, mobile)`)
                        .ilike('physical_bill_number', `%${searchTerm}%`);

                    const { data: nameData, error: nameError } = await supabaseClient
                        .from('orders')
                        .select(`id, created_at, total_amount, paid_amount, pending_amount, physical_bill_number, customers!inner(name, mobile)`)
                        .ilike('customers.name', `%${searchTerm}%`);

                    if (billError || nameError) { console.error('Search error:', billError || nameError); return; }

                    const combinedResults = [...(billData || []), ...(nameData || [])];
                    const uniqueResults = Array.from(new Map(combinedResults.map(order => [order.id, order])).values());
                    uniqueResults.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                    const count = uniqueResults.length;
                    totalOrderPages = Math.ceil(count / PAGE_SIZE);
                    currentOrderPage = page;
                    const paginatedData = uniqueResults.slice(from, to + 1);

                    displayOrders(paginatedData);
                    updatePaginationControls(count, 'order');
                }
            };

            const displayOrders = (orders) => {
                allElements.ordersTableBody.innerHTML = '';
                allElements.noOrdersMsg.classList.toggle('hidden', orders.length > 0);
                orders.forEach(order => {
                    const date = new Date(order.created_at).toLocaleString('en-IN', { dateStyle: 'short', timeStyle: 'short' });
                    const customerName = order.customers ? order.customers.name : 'N/A';
                    allElements.ordersTableBody.innerHTML += `<tr class="border-b"><td class="p-4">${date}</td><td class="p-4">${order.physical_bill_number || ''}</td><td class="p-4">${customerName}</td><td class="p-4">₹${Number(order.total_amount).toFixed(2)}</td><td class="p-4">₹${Number(order.paid_amount).toFixed(2)}</td><td class="p-4 text-red-600 font-semibold">₹${Number(order.pending_amount).toFixed(2)}</td><td class="p-4 flex gap-2"><button class="btn btn-outline text-xs" onclick="shareOrder(${order.id})">Share</button><button class="btn btn-outline text-xs" onclick="editOrder(${order.id})">Edit</button><button class="btn btn-delete text-xs" onclick="deleteOrder(${order.id})">Delete</button></td></tr>`;
                });
            };

            const updatePaginationControls = (totalCount, type) => {
                const pageInfo = allElements[`${type}PageInfo`];
                const prevBtn = allElements[`${type}PrevPageBtn`];
                const nextBtn = allElements[`${type}NextPageBtn`];
                const controls = allElements[`${type}PaginationControls`];
                const currentPage = type === 'order' ? currentOrderPage : currentInventoryPage;
                const totalPages = type === 'order' ? totalOrderPages : totalInventoryPages;

                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
                prevBtn.disabled = currentPage <= 1;
                nextBtn.disabled = currentPage >= totalPages;
                controls.classList.toggle('hidden', totalCount <= PAGE_SIZE);
            };
            
            allElements.searchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                fetchOrders(allElements.searchInput.value.trim(), 1);
            });
            allElements.clearSearchBtn.addEventListener('click', () => {
                allElements.searchInput.value = '';
                fetchOrders('', 1);
            });

            allElements.orderPrevPageBtn.addEventListener('click', () => { if (currentOrderPage > 1) { fetchOrders(allElements.searchInput.value.trim(), currentOrderPage - 1); } });
            allElements.orderNextPageBtn.addEventListener('click', () => { if (currentOrderPage < totalOrderPages) { fetchOrders(allElements.searchInput.value.trim(), currentOrderPage + 1); } });

            window.deleteOrder = async (orderId) => { if (!confirm('Are you sure you want to delete this order?')) return; const { error } = await supabaseClient.from('orders').delete().eq('id', orderId); if (error) { alert('Failed to delete order.'); } else { fetchOrders(); } };
            
            window.editOrder = async (orderId) => {
                const { data: order, error } = await supabaseClient.from('orders').select(`*, customers(*), order_items(*)`).eq('id', orderId).single();
                if (error) { alert('Could not fetch order details for editing.'); return; }

                resetOrderForm(); // Clear the form first
                currentEditingOrderId = order.id;
                currentEditingCustomerId = order.customers.id;

                // Populate customer fields
                document.getElementById('customer-name').value = order.customers.name;
                document.getElementById('customer-mobile').value = order.customers.mobile || '';
                document.getElementById('customer-address').value = order.customers.address || '';
                document.getElementById('physical-bill-number').value = order.physical_bill_number || '';
                
                // Populate financial fields
                document.getElementById('discount-amount').value = order.discount || 0;
                document.getElementById('paid-amount').value = order.paid_amount || 0;
                document.getElementById('remarks').value = order.remarks || '';

                // Populate items
                allElements.orderItemsContainer.innerHTML = ''; // Clear the initial empty row
                if (order.order_items.length > 0) {
                    order.order_items.forEach(item => addItemRow(item));
                } else {
                    addItemRow(); // Add one empty row if no items exist
                }
                
                calculateTotals();

                // Update modal UI for editing
                allElements.modalTitle.textContent = 'Edit Order';
                allElements.submitOrderBtn.textContent = 'Update Order';
                openModal(allElements.orderModal);
            };

            window.shareOrder = async (orderId) => {
                const { data: order, error } = await supabaseClient.from('orders').select(`*, customers(*), order_items(*)`).eq('id', orderId).single();
                if (error) { alert('Could not fetch order details for sharing.'); return; }

                if (!order.customers.mobile) {
                    alert('This customer does not have a mobile number saved.');
                    return;
                }

                let message = `*Order Summary from Gaurangi Jewellers*\n\n`;
                message += `*Bill No:* ${order.physical_bill_number || 'N/A'}\n`;
                message += `*Customer:* ${order.customers.name}\n`;
                message += `*Date:* ${new Date(order.created_at).toLocaleDateString('en-IN')}\n\n`;
                
                message += `*Items:*\n`;
                order.order_items.forEach(item => {
                    message += `- ${item.category} (${item.metal_type}): ${item.weight_grams}g @ ₹${item.rate_per_gram}/g + ₹${item.making_charge} making = *₹${item.subtotal.toFixed(2)}*\n`;
                });
                message += `\n`;

                const subtotal = order.total_amount - order.tax_amount;
                message += `*Subtotal:* ₹${subtotal.toFixed(2)}\n`;
                message += `*Tax (3%):* + ₹${order.tax_amount.toFixed(2)}\n`;
                message += `*Total:* *₹${order.total_amount.toFixed(2)}*\n`;
                message += `*Discount:* - ₹${order.discount.toFixed(2)}\n`;
                message += `*Paid Amount:* - ₹${order.paid_amount.toFixed(2)}*\n`;
                message += `*Pending Amount:* *₹${order.pending_amount.toFixed(2)}*\n\n`;
                
                if(order.remarks) {
                    message += `*Remarks:* ${order.remarks}\n\n`;
                }
                message += `Thank you for your business!`;

                const whatsappUrl = `https://wa.me/${order.customers.mobile}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            };

            // --- INVENTORY LOGIC ---
            const fetchInventory = async (searchTerm = '', page = 1) => {
                const from = (page - 1) * PAGE_SIZE;
                const to = page * PAGE_SIZE - 1;

                let query = supabaseClient.from('inventory').select('*', { count: 'exact' });

                if (searchTerm) {
                    query = query.or(`item_id.ilike.%${searchTerm}%,item_name.ilike.%${searchTerm}%`);
                }

                const { data, error, count } = await query
                    .order('created_at', { ascending: false })
                    .range(from, to);

                if (error) { console.error('Error fetching inventory:', error); return; }
                
                totalInventoryPages = Math.ceil(count / PAGE_SIZE);
                currentInventoryPage = page;
                displayInventory(data);
                updatePaginationControls(count, 'inventory');
            };

            const getPurityMultiplier = (purityString) => {
                if (!purityString || typeof purityString !== 'string') return 1;
                const number = parseFloat(purityString);
                if (isNaN(number)) return 1;

                if (purityString.toUpperCase().includes('K')) {
                    return number / 24;
                }
                if (purityString.includes('%')) {
                    return number / 100;
                }
                return 1; // Default if no unit is specified
            };

            const displayInventory = (items) => {
                allElements.inventoryTableBody.innerHTML = '';
                allElements.noInventoryMsg.classList.toggle('hidden', items.length > 0);
                items.forEach(item => {
                    const purityMultiplier = getPurityMultiplier(item.purity);
                    const itemValue = (item.weight_grams * item.unit_price * purityMultiplier) + item.making_charges;
                    const totalValue = (itemValue).toFixed(2); // Removed multiplication by stock_qty
                    allElements.inventoryTableBody.innerHTML += `<tr class="border-b"><td class="p-4">${new Date(item.purchase_date).toLocaleDateString('en-IN')}</td><td class="p-4">${item.item_id}</td><td class="p-4">${item.item_name}</td><td class="p-4">${item.category}</td><td class="p-4">${item.stock_qty}</td><td class="p-4">₹${totalValue}</td><td class="p-4 flex gap-2"><button class="btn btn-outline text-xs" onclick="editInventoryItem(${item.id})">Edit</button><button class="btn btn-delete text-xs" onclick="deleteInventoryItem(${item.id})">Delete</button></td></tr>`;
                });
            };

            allElements.inventorySearchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                fetchInventory(allElements.inventorySearchInput.value.trim(), 1);
            });
            allElements.inventoryClearSearchBtn.addEventListener('click', () => {
                allElements.inventorySearchInput.value = '';
                fetchInventory('', 1);
            });

            allElements.inventoryPrevPageBtn.addEventListener('click', () => { if (currentInventoryPage > 1) { fetchInventory(allElements.inventorySearchInput.value.trim(), currentInventoryPage - 1); } });
            allElements.inventoryNextPageBtn.addEventListener('click', () => { if (currentInventoryPage < totalInventoryPages) { fetchInventory(allElements.inventorySearchInput.value.trim(), currentInventoryPage + 1); } });

            const resetInventoryForm = () => {
                allElements.inventoryForm.reset();
                currentEditingInventoryId = null;
                allElements.inventoryModalTitle.textContent = 'Add New Item';
                allElements.submitInventoryBtn.textContent = 'Submit Item';
                document.getElementById('item-id').value = `GJ-${Date.now()}`;
            };

            window.editInventoryItem = async (itemId) => {
                const { data, error } = await supabaseClient.from('inventory').select('*').eq('id', itemId).single();
                if (error) { alert('Could not fetch item details.'); return; }

                resetInventoryForm();
                currentEditingInventoryId = data.id;

                document.getElementById('item-id').value = data.item_id;
                document.getElementById('item-name').value = data.item_name;
                document.getElementById('item-category').value = data.category || '';
                document.getElementById('item-material').value = data.material || '';
                document.getElementById('item-weight').value = data.weight_grams || '';
                document.getElementById('item-purity').value = data.purity || '';
                document.getElementById('item-stock').value = data.stock_qty;
                document.getElementById('item-price').value = data.unit_price || '';
                document.getElementById('item-making-charges').value = data.making_charges || 0;
                document.getElementById('item-supplier').value = data.supplier || '';
                document.getElementById('purchase-date').value = data.purchase_date;

                allElements.inventoryModalTitle.textContent = 'Edit Inventory Item';
                allElements.submitInventoryBtn.textContent = 'Update Item';
                openModal(allElements.inventoryModal);
            };

            window.deleteInventoryItem = async (itemId) => {
                if (!confirm('Are you sure you want to delete this inventory item?')) return;
                const { error } = await supabaseClient.from('inventory').delete().eq('id', itemId);
                if (error) { alert('Failed to delete item.'); } else { fetchInventory(); }
            };

            allElements.inventoryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                allElements.submitInventoryBtn.disabled = true;

                const itemData = {
                    item_id: document.getElementById('item-id').value,
                    item_name: document.getElementById('item-name').value,
                    category: document.getElementById('item-category').value,
                    material: document.getElementById('item-material').value,
                    weight_grams: parseFloat(document.getElementById('item-weight').value),
                    purity: document.getElementById('item-purity').value,
                    stock_qty: parseInt(document.getElementById('item-stock').value),
                    unit_price: parseFloat(document.getElementById('item-price').value),
                    making_charges: parseFloat(document.getElementById('item-making-charges').value),
                    supplier: document.getElementById('item-supplier').value,
                    purchase_date: document.getElementById('purchase-date').value
                };

                let error;
                if (currentEditingInventoryId) {
                    ({ error } = await supabaseClient.from('inventory').update(itemData).eq('id', currentEditingInventoryId));
                } else {
                    ({ error } = await supabaseClient.from('inventory').insert(itemData));
                }

                if (error) {
                    alert('Failed to save item. Item ID might already exist.');
                } else {
                    alert(`Item ${currentEditingInventoryId ? 'updated' : 'added'} successfully!`);
                    closeModal(allElements.inventoryModal);
                    fetchInventory();
                }

                allElements.submitInventoryBtn.disabled = false;
            });

            // --- INITIALIZE ---
            const checkSession = async () => { const { data: { session } } = await supabaseClient.auth.getSession(); if (session) { showDashboard(); } else { showLogin(); } };
            allElements.loginForm.addEventListener('submit', async (e) => { e.preventDefault(); const email = document.getElementById('email').value; const password = document.getElementById('password').value; allElements.loginButton.disabled = true; allElements.loginButton.textContent = 'Logging in...'; allElements.loginError.textContent = ''; const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password }); if (error) { allElements.loginError.textContent = 'Invalid login credentials.'; } else if (data.user) { showDashboard(); } allElements.loginButton.disabled = false; allElements.loginButton.textContent = 'Login'; });
            allElements.logoutButton.addEventListener('click', async () => { await supabaseClient.auth.signOut(); showLogin(); });
            const fetchCategories = async () => { const { data, error } = await supabaseClient.from('categories').select('*').order('name'); if (error) { console.error('Error fetching categories:', error); return; } allCategories = data; displayCategories(data); populateCategoryDropdown(data); populateInventoryCategoryDropdown([allElements.inventoryItemCategory]); };
            const displayCategories = (categories) => { allElements.categoryList.innerHTML = ''; categories.forEach(cat => { allElements.categoryList.innerHTML += `<div class="flex justify-between items-center bg-gray-50 p-2 rounded-md"><span>${cat.name}</span><button class="text-red-500 hover:text-red-700 font-bold text-xl" onclick="deleteCategory(${cat.id})">&times;</button></div>`; }); };
            const populateCategoryDropdown = (categories) => { allElements.imageCategorySelect.innerHTML = ''; if (categories.length === 0) { allElements.imageCategorySelect.innerHTML = '<option disabled>Please add a category first</option>'; } else { categories.forEach(cat => { allElements.imageCategorySelect.innerHTML += `<option value="${cat.name.toLowerCase()}">${cat.name}</option>`; }); } };
            const populateInventoryCategoryDropdown = (selects, selectedValue = null) => { selects.forEach(select => { select.innerHTML = ''; if (allCategories.length === 0) { select.innerHTML = '<option disabled>Please add a category first</option>'; } else { allCategories.forEach(cat => { const option = document.createElement('option'); option.value = cat.name; option.textContent = cat.name; if (selectedValue === cat.name) { option.selected = true; } select.appendChild(option); }); } }); };
            const fetchMaterials = async () => { const { data, error } = await supabaseClient.from('materials').select('*').order('name'); if (error) { console.error('Error fetching materials:', error); return; } populateInventoryMaterialDropdown(data); };
            const populateInventoryMaterialDropdown = (materials) => { allElements.inventoryItemMaterial.innerHTML = ''; if (materials.length === 0) { allElements.inventoryItemMaterial.innerHTML = '<option disabled>No materials found</option>'; } else { materials.forEach(mat => { allElements.inventoryItemMaterial.innerHTML += `<option value="${mat.name}">${mat.name}</option>`; }); } };
            const fetchSuppliers = async () => { const { data, error } = await supabaseClient.from('suppliers').select('*').order('name'); if (error) { console.error('Error fetching suppliers:', error); return; } populateInventorySupplierDropdown(data); };
            const populateInventorySupplierDropdown = (suppliers) => { allElements.inventoryItemSupplier.innerHTML = ''; if (suppliers.length === 0) { allElements.inventoryItemSupplier.innerHTML = '<option disabled>No suppliers found</option>'; } else { suppliers.forEach(sup => { allElements.inventoryItemSupplier.innerHTML += `<option value="${sup.name}">${sup.name}</option>`; }); } };
            const fetchAllInventoryItems = async () => { const { data, error } = await supabaseClient.from('inventory').select('id, item_name, material'); if(error) { console.error('Error fetching all inventory items:', error); return; } allInventoryItems = data; };
            const populateOrderItemInventoryDropdown = (select, selectedValue = null) => { select.innerHTML = ''; if(allInventoryItems.length === 0) { select.innerHTML = '<option disabled>No inventory items found</option>'; } else { allInventoryItems.forEach(item => { const option = document.createElement('option'); option.value = item.id; option.textContent = item.item_name; if(selectedValue === item.id) { option.selected = true; } select.appendChild(option); }); } };
            allElements.categoryForm.addEventListener('submit', async (e) => { e.preventDefault(); const categoryNameInput = document.getElementById('category-name'); const name = categoryNameInput.value.trim(); if (!name) return; const { error } = await supabaseClient.from('categories').insert([{ name: name }]); if (error) { alert('Failed to add category. It might already exist.'); } else { categoryNameInput.value = ''; fetchCategories(); } });
            window.deleteCategory = async (categoryId) => { if (!confirm('Are you sure you want to delete this category?')) return; const { error } = await supabaseClient.from('categories').delete().eq('id', categoryId); if (error) { alert('Failed to delete category.'); } else { fetchCategories(); } };
            const fetchCatalogImages = async () => { const { data, error } = await supabaseClient.storage.from(BUCKET_NAME).list('', { limit: 100, sortBy: { column: 'created_at', order: 'desc' } }); if (error) { console.error('Error fetching images:', error); return; } displayCatalogImages(data); };
            const displayCatalogImages = (images) => { allElements.catalogGrid.innerHTML = ''; const validImages = images.filter(img => img.name !== '.emptyFolderPlaceholder'); allElements.noImagesMsg.classList.toggle('hidden', validImages.length > 0); validImages.forEach(image => { const { data: { publicUrl } } = supabaseClient.storage.from(BUCKET_NAME).getPublicUrl(image.name); allElements.catalogGrid.innerHTML += `<div class="relative group border rounded-lg overflow-hidden"><img src="${publicUrl}" alt="${image.name}" class="w-full h-40 object-cover"><div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><button class="btn btn-delete text-xs" onclick="deleteImage('${image.name}')">Delete</button></div></div>`; }); };
            allElements.uploadForm.addEventListener('submit', async (e) => { e.preventDefault(); const title = document.getElementById('image-title').value; const category = document.getElementById('image-category').value; const file = document.getElementById('image-file').files[0]; if (!file || !category) { allElements.uploadStatus.textContent = 'Please select a file and category.'; return; } allElements.uploadBtn.disabled = true; allElements.uploadBtn.textContent = 'Uploading...'; const fileName = `${category}_${title.replace(/\s+/g, '-')}_${Date.now()}.${file.name.split('.').pop()}`; const { error } = await supabaseClient.storage.from(BUCKET_NAME).upload(fileName, file); if (error) { allElements.uploadStatus.textContent = 'Upload failed.'; } else { allElements.uploadStatus.textContent = 'Upload successful!'; allElements.uploadForm.reset(); fetchCatalogImages(); } allElements.uploadBtn.disabled = false; allElements.uploadBtn.textContent = 'Upload Image'; setTimeout(() => allElements.uploadStatus.textContent = '', 4000); });
            window.deleteImage = async (imageName) => { if (!confirm(`Are you sure you want to delete ${imageName}?`)) return; const { error } = await supabaseClient.storage.from(BUCKET_NAME).remove([imageName]); if (error) { alert('Failed to delete image.'); } else { fetchCatalogImages(); } };
            allElements.refreshImagesBtn.addEventListener('click', fetchCatalogImages);

            checkSession();
        });
    </script>
</body>
</html>
